generator client {
  provider = "prisma-client"
  output   = "generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum AppointmentType {
  NEW
  FOLLOWUP
}

enum AppointmentStatus {
  WAITING
  IN_CONSULTATION
  COMPLETED
  CANCELLED
}

enum BillStatus {
  PENDING
  PARTIAL
  PAID
  REFUNDED
  CANCELLED
}

enum TestStatus {
  ORDERED
  BILLED
  IN_PROGRESS
  COMPLETED
  REVIEWED
  RELEASED
  DELIVERED
  CANCELLED
}

enum NotificationType {
  APPOINTMENT
  TEST_READY
  PAYMENT
  QUEUE_UPDATE
  SYSTEM
}

model users {
  id                     String          @id @default(ulid())
  name                   String
  email                  String          @unique
  emailVerified          Boolean         @default(false)
  password               String?
  phone                  String?
  avatar                 String?
  isActive               Boolean         @default(true)
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  userRoles              user_roles[]
  employeeProfile        employees?
  sessions               sessions[]
  accounts               accounts[]      @relation("UserAccounts")
  documents              documents[]
  notifications          notifications[]
  initiatedAppointments  appointments[]  @relation("InitiatedAppointments")
  initiatedBills         bills[]         @relation("InitiatedBills")
  initiatedPayments      payments[]      @relation("InitiatedPayments")
  initiatedPrescriptions prescriptions[] @relation("InitiatedPrescriptions")
  initiatedTestOrders    test_orders[]   @relation("InitiatedTestOrders")
  initiatedTestResults   test_results[]  @relation("InitiatedTestResults")
  reviewedTestResults    test_results[]  @relation("ReviewedTestResults")
  initiatedPatients      patients[]      @relation("InitiatedPatients")
  auditLogs              audit_logs[]    @relation("AuditLogs")

  @@index([email])
  @@index([isActive])
}

model sessions {
  id        String   @id @default(ulid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model accounts {
  id                    String    @id @default(ulid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  users     @relation("UserAccounts", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, providerId])
  @@index([userId])
  @@index([providerId])
}

model verifications {
  id         String   @id @default(ulid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@index([identifier])
}

model roles {
  id              String             @id @default(ulid())
  name            String             @unique
  slug            String             @unique
  description     String?
  isSystem        Boolean            @default(false)
  isActive        Boolean            @default(true)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  userRoles       user_roles[]
  rolePermissions role_permissions[]

  @@index([slug])
  @@index([isSystem])
  @@index([isActive])
}

model permissions {
  id              String             @id @default(ulid())
  name            String             @unique
  slug            String             @unique
  module          String
  description     String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  rolePermissions role_permissions[]

  @@index([slug])
  @@index([module])
}

model role_permissions {
  id           String      @id @default(ulid())
  roleId       String
  permissionId String
  role         roles       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   permissions @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model user_roles {
  id     String @id @default(ulid())
  userId String
  roleId String
  user   users  @relation(fields: [userId], references: [id], onDelete: Cascade)
  role   roles  @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model departments {
  id          String      @id @default(ulid())
  name        String      @unique
  code        String      @unique
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  employees   employees[]
  labs        labs[]

  @@index([code])
  @@index([isActive])
}

model specializations {
  id                      String                     @id @default(ulid())
  name                    String                     @unique
  code                    String                     @unique
  description             String?                    @db.Text
  isActive                Boolean                    @default(true)
  createdAt               DateTime                   @default(now())
  updatedAt               DateTime                   @updatedAt
  employeeSpecializations employee_specializations[]

  @@index([code])
  @@index([isActive])
}

model employees {
  id                      String                     @id @default(ulid())
  userId                  String                     @unique
  departmentId            String?
  bio                     String?                    @db.Text
  qualification           String?                    @db.Text
  experiences             Json?
  certificates            Json?
  documents               Json?
  consultationFee         Float?
  hospitalFee             Float?                     @default(0)
  isAvailable             Boolean                    @default(true)
  createdAt               DateTime                   @default(now())
  updatedAt               DateTime                   @updatedAt
  user                    users                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  department              departments?               @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  employeeSpecializations employee_specializations[]
  doctorAppointments      appointments[]             @relation("DoctorAppointments")
  prescriptions           prescriptions[]

  @@index([userId])
  @@index([departmentId])
  @@index([isAvailable])
}

model employee_specializations {
  id               String          @id @default(ulid())
  employeeId       String
  specializationId String
  createdAt        DateTime        @default(now())
  employee         employees       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  specialization   specializations @relation(fields: [specializationId], references: [id], onDelete: Cascade)

  @@unique([employeeId, specializationId])
  @@index([employeeId])
  @@index([specializationId])
}

model patients {
  id              String         @id @default(ulid())
  patientId       String         @unique
  name            String
  age             Int
  phone           String
  gender          Gender?
  address         String?
  bloodGroup      BloodGroup?
  email           String?
  notes           String?
  isActive        Boolean        @default(true)
  initiatedBy     String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  initiatedByUser users          @relation("InitiatedPatients", fields: [initiatedBy], references: [id])
  appointments    appointments[]
  documents       documents[]
  bills           bills[]

  @@index([patientId])
  @@index([phone])
  @@index([name])
  @@index([isActive])
  @@index([createdAt])
  @@index([initiatedBy])
}

model appointments {
  id               String            @id @default(ulid())
  patientId        String
  doctorId         String
  appointmentType  AppointmentType
  chiefComplaint   String?           @db.Text
  diagnosis        String?           @db.Text
  serialNumber     Int
  queuePosition    Int
  status           AppointmentStatus @default(WAITING)
  entryTime        DateTime?
  exitTime         DateTime?
  appointmentDate  DateTime          @default(now())
  appointmentMonth String
  initiatedBy      String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  patient          patients          @relation(fields: [patientId], references: [id])
  doctor           employees         @relation("DoctorAppointments", fields: [doctorId], references: [id])
  initiatedByUser  users             @relation("InitiatedAppointments", fields: [initiatedBy], references: [id])
  bills            bills[]
  prescriptions    prescriptions[]
  testOrders       test_orders[]

  @@unique([doctorId, appointmentDate, serialNumber])
  @@unique([doctorId, appointmentDate, queuePosition])
  @@index([doctorId, appointmentDate, queuePosition])
  @@index([patientId, appointmentDate])
  @@index([status, appointmentDate])
  @@index([appointmentDate])
  @@index([appointmentMonth])
  @@index([createdAt])
  @@index([status])
  @@index([doctorId, status])
  @@index([initiatedBy])
}

model bills {
  id              String        @id @default(ulid())
  billNumber      String        @unique
  patientId       String
  appointmentId   String?
  billableType    String?
  billableId      String?
  totalAmount     Float
  paidAmount      Float         @default(0)
  dueAmount       Float
  discount        Float         @default(0)
  status          BillStatus    @default(PENDING)
  billingDate     DateTime      @default(now())
  dueDate         DateTime?
  notes           String?
  initiatedBy     String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  patient         patients      @relation(fields: [patientId], references: [id])
  appointment     appointments? @relation(fields: [appointmentId], references: [id])
  initiatedByUser users         @relation("InitiatedBills", fields: [initiatedBy], references: [id])
  billItems       bill_items[]
  payments        payments[]

  @@index([billNumber])
  @@index([patientId, status])
  @@index([appointmentId])
  @@index([status, billingDate])
  @@index([billableType, billableId])
  @@index([billingDate])
  @@index([createdAt])
  @@index([dueAmount])
  @@index([status, dueAmount])
  @@index([initiatedBy])
}

model bill_items {
  id           String  @id @default(ulid())
  billId       String
  itemableType String
  itemableId   String
  itemName     String
  quantity     Int     @default(1)
  unitPrice    Float
  discount     Float   @default(0)
  total        Float
  notes        String?
  bill         bills   @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@index([billId])
  @@index([itemableType, itemableId])
}

model payment_methods {
  id        String   @id @default(ulid())
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model payments {
  id              String        @id @default(ulid())
  billId          String
  amount          Float
  paymentMethod   String
  transactionId   String?
  initiatedBy     String
  status          String        @default("success")
  paymentDate     DateTime      @default(now())
  notes           String?
  metadata        Json?
  bill            bills         @relation(fields: [billId], references: [id])
  initiatedByUser users         @relation("InitiatedPayments", fields: [initiatedBy], references: [id])
  transaction     transactions?

  @@index([billId])
  @@index([paymentMethod])
  @@index([status])
  @@index([paymentDate])
  @@index([initiatedBy])
}

model medicines {
  id                String               @id @default(ulid())
  name              String
  genericName       String?
  type              String?
  manufacturer      String?
  strength          String?
  price             Float?
  stock             Int?
  minStock          Int?
  isActive          Boolean              @default(true)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  prescriptionItems prescription_items[]

  @@index([name])
  @@index([isActive])
  @@index([stock])
}

model medicine_instructions {
  id                String               @id @default(ulid())
  name              String               @unique
  description       String?
  isActive          Boolean              @default(true)
  prescriptionItems prescription_items[]

  @@index([isActive])
}

model prescriptions {
  id              String               @id @default(ulid())
  appointmentId   String               @unique
  doctorId        String
  notes           String?
  followUpDate    DateTime?
  initiatedBy     String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  appointment     appointments         @relation(fields: [appointmentId], references: [id])
  doctor          employees            @relation(fields: [doctorId], references: [id])
  initiatedByUser users                @relation("InitiatedPrescriptions", fields: [initiatedBy], references: [id])
  items           prescription_items[]

  @@index([doctorId])
  @@index([createdAt])
  @@index([initiatedBy])
}

model prescription_items {
  id             String                 @id @default(ulid())
  prescriptionId String
  medicineId     String
  instructionId  String?
  duration       String?
  notes          String?
  prescription   prescriptions          @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)
  medicine       medicines              @relation(fields: [medicineId], references: [id])
  instruction    medicine_instructions? @relation(fields: [instructionId], references: [id])

  @@index([prescriptionId])
  @@index([medicineId])
}

model labs {
  id           String       @id @default(ulid())
  name         String       @unique
  code         String       @unique
  departmentId String?
  description  String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  department   departments? @relation(fields: [departmentId], references: [id])
  testTypes    test_types[]

  @@index([code])
  @@index([isActive])
  @@index([departmentId])
}

model test_types {
  id          String          @id @default(ulid())
  name        String
  labId       String?
  code        String          @unique
  price       Float
  templateId  String?
  description String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  lab         labs?           @relation(fields: [labId], references: [id])
  template    test_templates? @relation(fields: [templateId], references: [id])
  testOrders  test_orders[]

  @@index([code])
  @@index([labId])
  @@index([isActive])
}

model test_templates {
  id          String       @id @default(ulid())
  name        String       @unique
  description String?
  fields      Json
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  testTypes   test_types[]

  @@index([isActive])
}

model test_orders {
  id              String        @id @default(ulid())
  appointmentId   String
  testTypeId      String
  initiatedBy     String
  status          TestStatus    @default(ORDERED)
  priority        String        @default("normal")
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  billId          String?
  appointment     appointments  @relation(fields: [appointmentId], references: [id])
  testType        test_types    @relation(fields: [testTypeId], references: [id])
  initiatedByUser users         @relation("InitiatedTestOrders", fields: [initiatedBy], references: [id])
  result          test_results?

  @@index([appointmentId])
  @@index([testTypeId, status])
  @@index([status, createdAt])
  @@index([createdAt])
  @@index([initiatedBy])
  @@index([priority])
}

model test_results {
  id              String      @id @default(ulid())
  testOrderId     String      @unique
  initiatedBy     String
  resultData      Json
  status          TestStatus  @default(IN_PROGRESS)
  reviewedBy      String?
  reviewNotes     String?
  completedAt     DateTime?
  releasedAt      DateTime?
  deliveredAt     DateTime?
  deliveredTo     String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  testOrder       test_orders @relation(fields: [testOrderId], references: [id])
  initiatedByUser users       @relation("InitiatedTestResults", fields: [initiatedBy], references: [id])
  reviewedByUser  users?      @relation("ReviewedTestResults", fields: [reviewedBy], references: [id])

  @@index([status, completedAt])
  @@index([initiatedBy])
  @@index([reviewedBy])
}

model documents {
  id             String   @id @default(ulid())
  patientId      String
  appointmentId  String?
  fileType       String
  fileName       String
  fileUrl        String
  fileSize       Int?
  uploadedBy     String
  uploadedAt     DateTime @default(now())
  patient        patients @relation(fields: [patientId], references: [id])
  uploadedByUser users    @relation(fields: [uploadedBy], references: [id])

  @@index([patientId])
  @@index([appointmentId])
  @@index([fileType])
  @@index([uploadedAt])
}

model notifications {
  id        String           @id @default(ulid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      users            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead, createdAt])
  @@index([createdAt])
}

model ledger_accounts {
  id           String         @id @default(ulid())
  name         String
  accountType  String
  balance      Float          @default(0)
  isActive     Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  transactions transactions[]

  @@index([accountType])
  @@index([isActive])
}

model transactions {
  id            String          @id @default(ulid())
  accountId     String
  paymentId     String?         @unique
  amount        Float
  type          String
  referenceType String?
  referenceId   String?
  description   String?
  createdAt     DateTime        @default(now())
  account       ledger_accounts @relation(fields: [accountId], references: [id])
  payment       payments?       @relation(fields: [paymentId], references: [id])

  @@index([accountId, createdAt])
  @@index([createdAt])
  @@index([referenceType, referenceId])
}

model settings {
  id        String   @id @default(ulid())
  key       String   @unique
  value     String
  type      String   @default("string")
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([isPublic])
}

model audit_logs {
  id        String   @id @default(ulid())
  userId    String
  action    String
  entity    String
  entityId  String?
  changes   Json?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  user      users    @relation("AuditLogs", fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([entity, entityId])
  @@index([createdAt])
  @@index([action])
}

model categories {
  id          String   @id @default(ulid())
  title       String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
